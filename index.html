<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hareem's Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .chat-container {
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 500px;
        }
        .chat-header {
            background-color: #6366f1; /* Indigo 500 */
            color: white;
            padding: 15px 20px;
            font-size: 1.25rem;
            font-weight: bold;
            text-align: center;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 10px;
            word-wrap: break-word;
        }
        .message.user {
            background-color: #e0e7ff; /* Indigo 100 */
            align-self: flex-end;
            color: #312e81; /* Indigo 800 */
        }
        .message.bot {
            background-color: #d1fae5; /* Green 100 */
            align-self: flex-start;
            color: #065f46; /* Green 800 */
        }
        .chat-input-area {
            display: flex;
            padding: 15px 20px;
            border-top: 1px solid #e5e7eb; /* Gray 200 */
            gap: 10px;
        }
        .chat-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #d1d5db; /* Gray 300 */
            border-radius: 20px;
            font-size: 1rem;
            outline: none;
        }
        .chat-input:focus {
            border-color: #6366f1; /* Indigo 500 */
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        .send-button {
            background-color: #6366f1; /* Indigo 500 */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .send-button:hover {
            background-color: #4f46e5; /* Indigo 600 */
            transform: translateY(-1px);
        }
        .send-button:active {
            background-color: #4338ca; /* Indigo 700 */
            transform: translateY(0);
        }
        .loading-indicator {
            align-self: flex-start;
            padding: 10px 15px;
            border-radius: 10px;
            background-color: #e0f2fe; /* Light blue for loading */
            color: #0c4a6e; /* Dark blue for loading text */
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            Hareem's Chatbot
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="message bot">Hi there! I'm Hareem. What would you like to know about me?</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" class="chat-input" placeholder="Type your message...">
            <button id="send-button" class="send-button">Send</button>
        </div>
    </div>

    <script type="module">
        // The API key will be provided by the environment at runtime.
        const apiKey = ""; // Leave this as an empty string.

        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');

        // Information about Hareem to provide to the LLM for persona
        const hareemPersona = `
            You are Hareem Farooq, a 16-year-old.
            You did your O Levels from Crescent and are currently waiting for your result which is in August.
            You love painting, reading, and playing many sports like football, cricket, basketball, and badminton.
            You also did horse riding when you were in kindergarten.
            You are currently writing diaries and will look forward to writing your own novels as well.
            You love cooking and baking.
            In your free time, you read novels, watch series/movies.
            You love eating Korean and Italian food.
            You love exploring new places and learning about new things.
            You love trying different kinds of food and drinks.
            You did your first internship at WWF Pakistan.
            You also did many MUNs (Model United Nations).
            You love watching F1 and you love to drive.
            You want to be a lawyer as you want to stand up for people.
            Answer questions as Hareem, using only the information provided about her. If a question is outside this scope, politely state that you can only answer based on Hareem's information.
        `;

        // Function to add a message to the chat interface
        function addMessage(text, sender, isTyping = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            if (isTyping) {
                messageDiv.classList.add('loading-indicator');
                messageDiv.textContent = 'Hareem is typing...';
            } else {
                messageDiv.textContent = text;
            }
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
            return messageDiv; // Return the element for potential removal/update
        }

        // Function to get bot response using Gemini API
        async function getBotResponse(userInput) {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: hareemPersona + "\n\nUser: " + userInput }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    // Using gemini-2.5-flash-preview-05-20 as requested for text generation
                    model: "gemini-2.5-flash-preview-05-20"
                }
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const maxRetries = 5;
            let attempt = 0;

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Handle HTTP errors
                        if (response.status === 429) { // Too Many Requests
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000; // Exponential backoff with jitter
                            console.warn(`Rate limit hit. Retrying in ${delay / 1000}s... (Attempt ${attempt + 1})`);
                            await new Promise(res => setTimeout(res, delay));
                            attempt++;
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        console.error("Unexpected API response structure:", result);
                        return "I'm sorry, I couldn't generate a response right now. Please try again.";
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    if (attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        console.warn(`Error during API call. Retrying in ${delay / 1000}s... (Attempt ${attempt + 1})`);
                        await new Promise(res => setTimeout(res, delay));
                        attempt++;
                    } else {
                        return "I'm having trouble connecting right now. Please try again later.";
                    }
                }
            }
            return "I'm currently unavailable. Please try again later.";
        }

        // Event listener for send button click
        sendButton.addEventListener('click', async () => {
            const userInput = chatInput.value.trim();
            if (userInput) {
                addMessage(userInput, 'user');
                chatInput.value = '';
                sendButton.disabled = true; // Disable button while waiting for response
                const loadingMessage = addMessage('', 'bot', true); // Show typing indicator

                try {
                    const botResponse = await getBotResponse(userInput);
                    loadingMessage.remove(); // Remove typing indicator
                    addMessage(botResponse, 'bot');
                } catch (error) {
                    console.error("Failed to get bot response:", error);
                    loadingMessage.remove(); // Remove typing indicator
                    addMessage("Oops! Something went wrong while getting my response. Please try again.", 'bot');
                } finally {
                    sendButton.disabled = false; // Re-enable button
                }
            }
        });

        // Event listener for Enter key press in the input field
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !sendButton.disabled) {
                sendButton.click();
            }
        });
    </script>
</body>
</html>
